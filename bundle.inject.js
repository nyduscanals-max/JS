// bundle.inject.js (배포용: 순수 JS)
/* eslint-disable */
(()=>{"use strict";
if(window.__SOOP_RECAP_LOADED__)return;window.__SOOP_RECAP_LOADED__=1;
if(!/m\.sooplive\.co\.kr$/.test(location.host)||!/^\/statistics\/a\/watch\//.test(location.pathname))
  return alert("SOOP 시청 통계 페이지(모바일)에서만 실행됩니다.\nhttps://m.sooplive.co.kr/statistics/a/watch/... 페이지에서 실행해 주세요.");

const U="me",I={R:"my-soop-recap-root",S:"my-soop-recap-style",B:"my-soop-recap-body",P:"my-soop-period",R0:"my-soop-recap-run",SV:"my-soop-recap-save",X:"my-soop-recap-close",ST:"my-soop-recap-status",L:"my-soop-left-card",RR:"my-soop-right-card"},Z0=1200,ZD=500,T={a:"rgba(165,203,245,.95)",b:"rgba(238,248,255,.9)",bd:"rgba(125,155,205,.25)",sh:"rgba(28,60,120,.12)",tx:"rgba(16,24,40,.92)",sub:"rgba(16,24,40,.62)",card:"rgba(255,255,255,.92)",acc:"rgba(73,122,255,1)",acc2:"rgba(60,200,195,1)",t1:"rgba(194,247,241,.8)",t2:"rgba(210,233,255,.8)",t3:"rgba(255,245,208,.8)"},C=[{d:"rgba(34,197,171,1)",a:"rgba(194,247,241,.75)",b:"rgba(255,255,255,0)"},{d:"rgba(59,130,246,1)",a:"rgba(210,233,255,.75)",b:"rgba(255,255,255,0)"},{d:"rgba(250,204,21,1)",a:"rgba(255,245,208,.78)",b:"rgba(255,255,255,0)"},{d:"rgba(251,146,60,1)",a:"rgba(255,232,214,.72)",b:"rgba(255,255,255,0)"},{d:"rgba(251,113,133,1)",a:"rgba(255,221,231,.72)",b:"rgba(255,255,255,0)"},{d:"rgba(168,85,247,1)",a:"rgba(235,223,255,.70)",b:"rgba(255,255,255,0)"},{d:"rgba(20,184,166,1)",a:"rgba(204,251,241,.70)",b:"rgba(255,255,255,0)"},{d:"rgba(132,204,22,1)",a:"rgba(236,252,203,.70)",b:"rgba(255,255,255,0)"},{d:"rgba(99,102,241,1)",a:"rgba(221,226,255,.72)",b:"rgba(255,255,255,0)"},{d:"rgba(244,63,94,1)",a:"rgba(255,228,235,.70)",b:"rgba(255,255,255,0)"}],K=i=>C[i%C.length],$=(s,p=document)=>p.querySelector(s),sl=t=>new Promise(r=>setTimeout(r,t)),esc=s=>String(s??"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c])),ymd=s=>/^\d{4}-\d{2}-\d{2}$/.test(String(s||"").trim()),hms=s=>{s=Math.max(0,s|0);const h=(s/3600)|0,m=((s%3600)/60)|0;return{t:`${h}시간 ${m}분`}},mins=s=>`${Math.round(Math.max(0,(+s||0))/60).toLocaleString()}분`,pct=(a,b)=>b?`${((a/b)*100).toFixed(1)}%`:"0.0%",fr=()=>{const pv=e=>(e&&typeof e.value=="string")?e.value.trim():"";let s=pv($('input[name="szStartDate"]'))||pv($("#szStartDate"))||pv($('input[name*="StartDate" i]')),e=pv($('input[name="szEndDate"]'))||pv($("#szEndDate"))||pv($('input[name*="EndDate" i]'));if(ymd(s)&&ymd(e))return{start:s,end:e};const a=[...document.querySelectorAll('input[type="text"],input:not([type])')].map(pv).filter(ymd);return a.length>=2?{start:a[0],end:a[1]}:null},gr=async(t=12,d=200)=>{for(let i=0;i<t;i++){let r=fr();if(r)return r;await sl(d)}return null},fs=async(s,e)=>{const f=new URLSearchParams;f.set("szModule","UserLiveWatchTimeData");f.set("szMethod","watch");f.set("szStartDate",s);f.set("szEndDate",e);f.set("nPage","1");f.set("szId",U);const r=await fetch("https://broadstatistic.sooplive.co.kr/api/watch_statistic.php",{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:f.toString()}),t=await r.text();try{const j=JSON.parse(t);return j&&j.result===1?{ok:1,j}:{ok:0,why:"API_FAIL",j}}catch(_){return{ok:0,why:"JSON_PARSE",raw:t}}},mz=j=>{const d=j?.data,ch=d?.chart,b=d?.broad_cast_info?.data,total=+(b?.cumulative_watch_time||0);let pc=0,mob=0;(Array.isArray(ch?.data)?ch.data:[]).forEach(r=>{pc+=+(r?.pc_watch_time||0);mob+=+(r?.mobile_watch_time||0)});const items=(Array.isArray(ch?.data_stack)?ch.data_stack:[]).map(s=>{const n=String(s?.bj_nick??"").trim(),sec=(Array.isArray(s?.data)?s.data:[]).reduce((a,b)=>a+(+b||0),0);return{name:n,sec}}).filter(x=>x.name&&x.sec>0&&x.name!=="기타").sort((a,b)=>b.sec-a.sec),top10=items.slice(0,10);return{upd:String(d?.updatetime||""),total,pc,mob,top10,fave:top10[0]||null}},di=e=>{if(!e||e.nodeType!==1||e.tagName!=="INPUT")return 0;const t=(e.getAttribute("type")||"").toLowerCase();if(t&&t!=="text"&&t!=="date")return 0;const v=String(e.value||"").trim(),h=`${e.name||""} ${e.id||""} ${e.placeholder||""}`.toLowerCase();return ymd(v)||/date|day|start|end|기간|시작|종료/.test(h)},setZ=z=>{const r=$(`#${I.R}`);r&&(r.style.zIndex=""+z)};let dp=0,tm=null;const on=()=>{dp||(dp=1,setZ(ZD))},off=()=>{tm&&clearTimeout(tm);tm=setTimeout(()=>{dp=0;setZ(Z0)},250)},idp=()=>{document.addEventListener("focusin",e=>{di(e.target)&&on()},1);document.addEventListener("focusout",e=>{di(e.target)&&off()},1);document.addEventListener("click",e=>{dp&&!di(e.target)&&off()},1)},lh2c=()=>new Promise((r,j)=>{if(window.html2canvas)return r();const s=document.createElement("script");s.src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js";s.onload=r;s.onerror=()=>j(Error("h2c"));document.head.appendChild(s)}),st=m=>{const e=$(`#${I.ST}`);e&&(e.textContent=m||"")},prd=(s,e,u)=>{const p=$(`#${I.P}`);p&&(p.textContent=`기간: ${(ymd(s)&&ymd(e))?`${s} ~ ${e}`:"-"}${u?` · 업데이트: ${u}`:""}`)},sh=()=>{const l=$(`#${I.L}`),r=$(`#${I.RR}`);if(!l||!r)return;const h=l.getBoundingClientRect().height|0;r.style.setProperty("--pairH",`${Math.max(0,h)}px`)},
sv=async()=>{const root=$(`#${I.R}`),wrap=root?.querySelector(".wrap");if(!root||!wrap)return alert("저장할 영역(.wrap)을 찾지 못했습니다.");try{st("이미지 생성 중…");await lh2c();root.classList.add("capturing","cap");await (document.fonts?.ready||Promise.resolve());await sl(120);const cv=await window.html2canvas(wrap,{backgroundColor:"#fff",scale:Math.max(2,window.devicePixelRatio||1),useCORS:!0,logging:!1}),a=document.createElement("a");a.download=`soop-recap-${new Date().toISOString().replace(/[:.]/g,"-")}.png`;a.href=cv.toDataURL("image/png");a.click();st("저장 완료");setTimeout(()=>st(""),1200)}catch(_){st("");alert("저장에 실패했습니다. (브라우저/확장/보안 설정 영향 가능)")}finally{root?.classList.remove("capturing","cap")}},
css=()=>{if($(`#${I.S}`))return;const s=document.createElement("style");s.id=I.S;s.textContent=`#${I.R},#${I.R} *{box-sizing:border-box}#${I.R}{font-family:system-ui,-apple-system,"Apple SD Gothic Neo","Malgun Gothic","Noto Sans KR","Segoe UI",Roboto,sans-serif;position:sticky;top:0;z-index:${Z0};width:100%;margin:0;padding:0;background:linear-gradient(180deg,${T.a},${T.b});box-shadow:0 18px 45px ${T.sh};backdrop-filter:blur(10px);border-bottom:1px solid ${T.bd}}.ui-datepicker,.datepicker,.react-datepicker,.react-datepicker-popper,.flatpickr-calendar,.vdp-datepicker__calendar,.mx-datepicker-popup,.pika-single{z-index:6000!important}#${I.R} .wrap{max-width:min(1200px,96vw);margin:0 auto;padding:14px 0}#${I.R} .header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:2px 6px 10px}#${I.R} .hLeft{min-width:280px}#${I.R} .title{font-weight:900;font-size:15px;letter-spacing:-.2px;color:${T.tx};display:flex;align-items:center;gap:8px}#${I.R} .title .dot{width:10px;height:10px;border-radius:999px;background:${T.acc};box-shadow:0 8px 18px rgba(73,122,255,.25)}#${I.R} .period{margin-top:6px;font-size:12px;color:${T.sub}}#${I.R} .hRight{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}#${I.R} .status{font-size:12px;color:${T.sub};white-space:nowrap}#${I.R} .btn{border:0;padding:9px 14px;border-radius:999px;cursor:pointer;font-weight:900;color:#fff;background:linear-gradient(135deg,${T.acc},#7a5cff);box-shadow:0 8px 18px rgba(79,125,255,.25)}#${I.R} .btn.secondary{color:${T.tx};background:rgba(255,255,255,.72);border:1px solid ${T.bd};box-shadow:0 10px 22px rgba(30,40,90,.06)}#${I.R} .btn.ghost{color:${T.sub};background:transparent;border:1px solid transparent;box-shadow:none}#${I.R} .content{padding:0 6px}#${I.R} .frame{max-width:1400px;margin:0 auto;padding:12px;background:rgba(255,255,255,.35);border-radius:24px;box-shadow:0 20px 50px rgba(30,40,90,.10),inset 0 0 0 1px rgba(255,255,255,.35);backdrop-filter:blur(6px)}#${I.R} .grid3{display:grid;grid-template-columns:1.1fr 1.1fr 1fr;gap:12px}@media(max-width:1100px){#${I.R} .grid3{grid-template-columns:1fr}}#${I.R} .card{background:${T.card};border:1px solid ${T.bd};border-radius:16px;padding:14px;box-shadow:0 10px 24px rgba(30,40,90,.06)}#${I.R} .cardTitle{font-size:12px;color:${T.sub};font-weight:900}#${I.R} .big{margin-top:6px;font-size:22px;font-weight:900;letter-spacing:-.3px;color:${T.tx}}#${I.R} .hint{margin-top:6px;font-size:12px;color:${T.sub}}#${I.R} .pmCard{display:flex;flex-direction:column}#${I.R} .pmBody{flex:1;display:flex;flex-direction:column;justify-content:center}#${I.R} .pmBody .bar{margin-top:8px}#${I.R} .pmBody .barMeta{margin-top:10px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}#${I.R} .bar{height:12px;background:rgba(120,130,200,.14);border-radius:999px;overflow:hidden;border:1px solid rgba(120,130,200,.18)}#${I.R} .bar>div{height:100%;background:linear-gradient(90deg,${T.acc},${T.acc2})}#${I.R} .split{display:grid;grid-template-columns:.95fr 1.05fr;gap:12px;margin-top:12px;align-items:stretch}@media(max-width:1100px){#${I.R} .split{grid-template-columns:1fr}}#${I.R} .split>.card{height:100%;display:flex;flex-direction:column}#${I.R} .card.syncH{min-height:var(--pairH,auto)}#${I.R} .list{margin-top:10px;border-radius:12px;overflow:hidden;border:1px solid rgba(120,130,200,.16);margin-bottom:10px}#${I.R} .row{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(120,130,200,.16);font-size:13px;background:rgba(255,255,255,.78)}#${I.R} .row:last-child{border-bottom:none}#${I.R} .row.rank1{background:linear-gradient(90deg,${T.t1},rgba(255,255,255,0))}#${I.R} .row.rank2{background:linear-gradient(90deg,${T.t2},rgba(255,255,255,0))}#${I.R} .row.rank3{background:linear-gradient(90deg,${T.t3},rgba(255,255,255,0))}#${I.R} .rank{width:22px;color:${T.sub};font-variant-numeric:tabular-nums}#${I.R} .chip{width:10px;height:10px;border-radius:999px;border:1px solid rgba(0,0,0,.06);flex:0 0 auto}#${I.R} .name{flex:1;font-weight:900;color:${T.tx};overflow:hidden;text-overflow:ellipsis;white-space:nowrap}#${I.R} .mins{width:92px;text-align:right;color:${T.tx};font-variant-numeric:tabular-nums}#${I.R} .pct{width:60px;text-align:right;color:${T.sub};font-variant-numeric:tabular-nums}#${I.R} .top10Footer{margin-top:auto;padding:8px 12px 6px;border-top:1px solid rgba(120,130,200,.18);font-size:12px;color:rgba(16,24,40,.72);display:flex;justify-content:center;gap:24px}#${I.R} .top10Footer>div{display:inline-flex;align-items:center;gap:8px;padding:6px 9px;border-radius:999px;border:1px solid rgba(120,130,200,.16);background:linear-gradient(135deg,rgba(210,233,255,.55),rgba(255,255,255,0));box-shadow:0 8px 18px rgba(30,40,90,.04);transition:box-shadow .15s,transform .15s}#${I.R} .top10Footer>div:hover{box-shadow:0 10px 22px rgba(30,40,90,.08);transform:translateY(-1px)}#${I.R} .top10Footer>div::before{content:"";width:8px;height:8px;border-radius:999px;background:${T.acc};box-shadow:0 6px 12px rgba(73,122,255,.18)}#${I.R} .top10Footer>div:nth-child(2)::before{background:${T.acc2};box-shadow:0 6px 12px rgba(60,200,195,.18)}#${I.R} .top10Footer strong{font-weight:900;color:rgba(16,24,40,.85)}#${I.R} .top10Footer span{margin-left:6px;font-weight:700;color:rgba(16,24,40,.9);font-variant-numeric:tabular-nums}#${I.R} .mapWrap{flex:1;min-height:0;display:flex;margin-top:10px}#${I.R} .mapGrid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:10px;align-content:start;width:100%;height:100%}#${I.R} .tile{position:relative;border-radius:16px;border:1px solid rgba(120,130,200,.22);overflow:hidden;padding:12px 12px 10px;min-height:92px;box-shadow:0 10px 22px rgba(30,40,90,.06)}#${I.R} .tile .dot{position:absolute;right:12px;top:12px;width:10px;height:10px;border-radius:999px;box-shadow:0 8px 18px rgba(0,0,0,.12)}#${I.R} .tile .tName{font-weight:900;font-size:13px;line-height:1.25;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;word-break:keep-all;color:${T.tx}}#${I.R} .tile .tVal{margin-top:6px;font-size:12px;color:rgba(20,30,50,.70);font-variant-numeric:tabular-nums;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}#${I.R} .t1{grid-column:span 7;min-height:138px}#${I.R} .t2{grid-column:span 5;min-height:110px}#${I.R} .t3{grid-column:span 6;min-height:110px}#${I.R} .t4{grid-column:span 6}#${I.R} .t5,#${I.R} .t6,#${I.R} .t7,#${I.R} .t8,#${I.R} .t9,#${I.R} .t10{grid-column:span 4}@media(max-width:1100px){#${I.R} .t1,#${I.R} .t2,#${I.R} .t3,#${I.R} .t4,#${I.R} .t5,#${I.R} .t6,#${I.R} .t7,#${I.R} .t8,#${I.R} .t9,#${I.R} .t10{grid-column:span 12}}#${I.R}.capturing .hRight,#${I.R}.capturing .status{visibility:hidden!important}#${I.R}.cap{position:relative!important;backdrop-filter:none!important}#${I.R}.cap .frame{backdrop-filter:none!important;background:rgba(255,255,255,.92)!important}#${I.R}.cap .card,#${I.R}.cap .tile{box-shadow:0 10px 22px rgba(30,40,90,.06)!important}`;document.head.appendChild(s)},
rd=m=>{const b=$(`#${I.B}`);if(!b)return;const total=hms(m.total),pc=hms(m.pc),mob=hms(m.mob),sum=m.pc+m.mob,pr=sum?m.pc/sum:0;const rows=m.top10.map((it,i)=>{const cl=i===0?"rank1":i===1?"rank2":i===2?"rank3":"",cc=K(i);return`<div class="row ${cl}"><div class="rank">${i+1}</div><div class="chip" style="background:${cc.d}"></div><div class="name">${esc(it.name)}</div><div class="mins">${mins(it.sec)}</div><div class="pct">${pct(it.sec,m.total)}</div></div>`}).join(""),sp=i=>i===0?"t1":i===1?"t2":i===2?"t3":i===3?"t4":i===4?"t5":i===5?"t6":i===6?"t7":i===7?"t8":i===8?"t9":"t10",tiles=m.top10.map((it,i)=>{const cc=K(i);return`<div class="tile ${sp(i)}" style="background:linear-gradient(135deg,${cc.a},${cc.b})"><div class="dot" style="background:${cc.d}"></div><div class="tName">${esc(it.name)}</div><div class="tVal">${mins(it.sec)} · ${pct(it.sec,m.total)}</div></div>`}).join(""),fave=m.fave?`<div class="big">${esc(m.fave.name)}</div><div class="hint">${mins(m.fave.sec)} 시청</div>`:`<div class="big">-</div><div class="hint">데이터 없음</div>`,topSum=m.top10.reduce((a,x)=>a+x.sec,0),rest=Math.max(0,m.total-topSum);b.innerHTML=`<div class="grid3"><div class="card"><div class="cardTitle">총 시청 시간</div><div class="big">${total.t}</div><div class="hint">(${mins(m.total)})</div></div><div class="card"><div class="cardTitle">최애 스트리머</div>${fave}</div><div class="card pmCard"><div class="cardTitle">PC / 모바일 (시간 기준)</div><div class="pmBody"><div class="bar"><div style="width:${(pr*100).toFixed(1)}%"></div></div><div class="barMeta"><div>PC ${(pr*100).toFixed(1)}% · ${pc.t}</div><div>모바일 ${(100-pr*100).toFixed(1)}% · ${mob.t}</div></div></div></div></div><div class="split"><div class="card" id="${I.L}"><div class="cardTitle" style="font-weight:900;color:${T.tx}">TOP 10</div><div class="list">${rows||`<div class="row"><div class="name">데이터 없음</div></div>`}</div><div class="top10Footer"><div><strong>TOP10 합계</strong><span>${mins(topSum)} · ${pct(topSum,m.total)}</span></div><div><strong>TOP10 외</strong><span>${mins(rest)} · ${pct(rest,m.total)}</span></div></div></div><div class="card syncH" id="${I.RR}"><div class="cardTitle" style="font-weight:900;color:${T.tx}">비중 카드맵</div><div class="mapWrap"><div class="mapGrid">${tiles||""}</div></div></div></div>`;sh()},
en=()=>{$(`#${I.R}`)||(css(),idp(),(()=>{const r=document.createElement("div");r.id=I.R;r.innerHTML=`<div class="wrap"><div class="header"><div class="hLeft"><div class="title"><span class="dot"></span><span>내 숲 시청 리캡</span></div><div class="period" id="${I.P}">기간: -</div></div><div class="hRight"><button class="btn secondary" id="${I.SV}" title="이미지로 저장">저장</button><button class="btn" id="${I.R0}">리캡 만들기</button><button class="btn ghost" id="${I.X}">닫기</button><span class="status" id="${I.ST}"></span></div></div><div class="content"><div class="frame" id="${I.B}"></div></div></div>`;document.body.prepend(r);$(`#${I.R0}`).addEventListener("click",run);$(`#${I.SV}`).addEventListener("click",sv);$(`#${I.X}`).addEventListener("click",()=>r.remove());r.style.zIndex=""+Z0})())},
run=async()=>{en();st("준비 중…");const rg=await gr();if(!rg)return alert("기간(시작/종료 날짜)을 페이지에서 찾지 못했습니다.\n페이지에서 날짜를 먼저 선택한 뒤 다시 눌러주세요."),st(""),void 0;st("데이터 불러오는 중…");const api=await fs(rg.start,rg.end);if(!api.ok)return alert(api.why==="JSON_PARSE"?"서버 응답이 JSON이 아닙니다. (로그인/세션 만료 가능)\n다시 로그인 후 재시도해 주세요.":"데이터를 가져오지 못했습니다.\n로그인 상태/기간을 확인해 주세요."),st(""),void 0;const m=mz(api.j);prd(rg.start,rg.end,m.upd);if(!m.top10.length)return $(`#${I.B}`).innerHTML=`<div class="card" style="max-width:min(1200px,96vw);margin:0 auto"><div class="cardTitle">데이터 없음</div><div class="hint" style="margin-top:8px">해당 기간에 시청 기록이 없거나, 권한/로그인 상태 때문에 데이터를 못 받은 것 같아요.</div></div>`,st(""),void 0;rd(m);st("완료");setTimeout(()=>st(""),1200);window.addEventListener("resize",sh,{passive:!0})};
en()})();